apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: skopeo-copy
  namespace: uxie-cicd
spec:
  description: |
    Copy image to external registry (Nexus) using Skopeo.
    Used for QA releases to make images available outside cluster.
  params:
    - name: srcImage
      description: Source image (internal registry)
      type: string
    - name: destImage
      description: Destination image (Nexus registry)
      type: string
    - name: srcTlsVerify
      description: Verify TLS for source
      type: string
      default: "false"
    - name: destTlsVerify
      description: Verify TLS for destination
      type: string
      default: "false"
  workspaces:
    - name: nexus-credentials
      description: Workspace with Nexus auth config
      optional: true
  steps:
    - name: copy
      image: registry.redhat.io/rhel8/skopeo:latest
      script: |
        #!/bin/bash
        set -e

        # Source auth (OpenShift SA token)
        mkdir -p ~/.docker
        SRC_REGISTRY=$(echo "$(params.srcImage)" | cut -d'/' -f1)

        echo "Configuring source registry auth: $SRC_REGISTRY"
        SA_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
        echo "{\"auths\":{\"$SRC_REGISTRY\":{\"auth\":\"$(echo -n "serviceaccount:$SA_TOKEN" | base64 -w0)\"}}}" > ~/.docker/config-src.json

        # Destination auth (Nexus)
        DEST_REGISTRY=$(echo "$(params.destImage)" | cut -d'/' -f1)
        echo "Configuring destination registry auth: $DEST_REGISTRY"

        if [ -f "$(workspaces.nexus-credentials.path)/config.json" ]; then
          cp $(workspaces.nexus-credentials.path)/config.json ~/.docker/config-dest.json
        else
          # Default Nexus credentials (dev)
          echo "{\"auths\":{\"$DEST_REGISTRY\":{\"auth\":\"$(echo -n "admin:nexusabc" | base64 -w0)\"}}}" > ~/.docker/config-dest.json
        fi

        echo "Copying image:"
        echo "  From: $(params.srcImage)"
        echo "  To:   $(params.destImage)"

        skopeo copy \
          --src-tls-verify=$(params.srcTlsVerify) \
          --dest-tls-verify=$(params.destTlsVerify) \
          --src-authfile=~/.docker/config-src.json \
          --dest-authfile=~/.docker/config-dest.json \
          docker://$(params.srcImage) \
          docker://$(params.destImage)

        echo "Image copied to external registry successfully"
