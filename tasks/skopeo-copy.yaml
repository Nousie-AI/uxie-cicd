apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: skopeo-copy
  namespace: uxie-cicd
spec:
  description: |
    Copy image to external registry (Nexus) using Skopeo.
    Used for QA releases to make images available outside cluster.
  params:
    - name: srcImage
      description: Source image (internal registry)
      type: string
    - name: destImage
      description: Destination image (Nexus registry)
      type: string
    - name: srcTlsVerify
      description: Verify TLS for source
      type: string
      default: "false"
    - name: destTlsVerify
      description: Verify TLS for destination
      type: string
      default: "false"
  workspaces:
    - name: nexus-credentials
      description: Workspace with Nexus auth config
      optional: true
  steps:
    - name: copy
      image: quay.io/skopeo/stable:latest
      script: |
        #!/bin/sh
        set -e

        # Get service account token for source auth
        SA_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)

        echo "Copying image:"
        echo "  From: $(params.srcImage)"
        echo "  To:   $(params.destImage)"

        skopeo copy \
          --src-tls-verify=$(params.srcTlsVerify) \
          --dest-tls-verify=$(params.destTlsVerify) \
          --src-creds="serviceaccount:${SA_TOKEN}" \
          --dest-creds="admin:nexusabc" \
          docker://$(params.srcImage) \
          docker://$(params.destImage)

        echo "Image copied to external registry successfully"
