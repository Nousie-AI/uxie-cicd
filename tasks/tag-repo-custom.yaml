apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: tag-repo-custom
  namespace: uxie-cicd
spec:
  description: |
    Tag the source repository with the generated version tag.
    Only runs for QA environment (main branch).
  params:
    - name: gitRepoUrl
      description: Git repository URL (SSH)
      type: string
    - name: imageTag
      description: Tag to apply to the repository
      type: string
  workspaces:
    - name: source
      description: Workspace with cloned repository
    - name: ssh-directory
      description: SSH credentials for git push
      optional: true
  steps:
    - name: tag-repo
      image: registry.redhat.io/openshift-pipelines/pipelines-git-init-rhel8:latest
      workingDir: $(workspaces.source.path)
      script: |
        #!/bin/bash
        set -e

        # Configure SSH if credentials provided
        if [ -d "$(workspaces.ssh-directory.path)" ]; then
          cp -R $(workspaces.ssh-directory.path)/* ~/.ssh/
          chmod 700 ~/.ssh
          chmod 600 ~/.ssh/*
        fi

        # Configure git
        git config user.email "cicd@nousie-ai.com"
        git config user.name "UXIE CI/CD"

        # Create and push tag
        TAG="$(params.imageTag)"

        echo "Creating tag: $TAG"
        git tag -a "$TAG" -m "Release $TAG - Generated by UXIE CI/CD"

        echo "Pushing tag to remote..."
        git push origin "$TAG"

        echo "Tag $TAG pushed successfully"
