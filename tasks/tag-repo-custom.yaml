apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: tag-repo-custom
  namespace: uxie-cicd
spec:
  description: |
    Tag the source repository with the generated version tag.
    Only runs for QA environment (main branch).
  params:
    - name: gitRepoUrl
      description: Git repository URL (SSH)
      type: string
    - name: imageTag
      description: Tag to apply to the repository
      type: string
  workspaces:
    - name: source
      description: Workspace with cloned repository
    - name: ssh-directory
      description: SSH credentials for git push
      optional: true
  steps:
    - name: tag-repo
      image: alpine/git:latest
      workingDir: $(workspaces.source.path)/source
      script: |
        #!/bin/sh
        set -e

        # Change to the source directory with .git
        REPO_DIR="$(workspaces.source.path)/source"
        cd "$REPO_DIR"

        SSH_DIR="$(workspaces.ssh-directory.path)"

        # Configure SSH if credentials provided
        if [ -d "$SSH_DIR" ] && [ "$(ls -A $SSH_DIR 2>/dev/null)" ]; then
          echo "Configuring SSH credentials..."
          mkdir -p ~/.ssh

          # Copy known_hosts if exists
          if [ -f "$SSH_DIR/known_hosts" ]; then
            cp "$SSH_DIR/known_hosts" ~/.ssh/known_hosts
            chmod 644 ~/.ssh/known_hosts
          fi

          # Copy private key (handle both 'ssh-privatekey' and 'id_rsa' names)
          if [ -f "$SSH_DIR/ssh-privatekey" ]; then
            cp "$SSH_DIR/ssh-privatekey" ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa
          elif [ -f "$SSH_DIR/id_rsa" ]; then
            cp "$SSH_DIR/id_rsa" ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa
          fi

          chmod 700 ~/.ssh

          # Disable strict host key checking for GitHub
          echo "Host github.com" >> ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config
          echo "  UserKnownHostsFile /dev/null" >> ~/.ssh/config
          chmod 600 ~/.ssh/config

          echo "SSH configured successfully"
        else
          echo "Warning: No SSH credentials found"
        fi

        # Mark directory as safe (required when running as different user than owner)
        git config --global --add safe.directory "$REPO_DIR"

        # Configure git
        git config user.email "cicd@nousie-ai.com"
        git config user.name "UXIE CI/CD"

        # Create and push tag
        TAG="$(params.imageTag)"

        echo "Creating tag: $TAG"
        git tag -a "$TAG" -m "Release $TAG - Generated by UXIE CI/CD"

        echo "Pushing tag to remote..."
        GIT_SSH_COMMAND="ssh -o StrictHostKeyChecking=no" git push origin "$TAG"

        echo "Tag $TAG pushed successfully"
