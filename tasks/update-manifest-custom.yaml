apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-manifest-custom
  namespace: uxie-cicd
spec:
  description: |
    Update GitOps manifest repository with new image tag.
    Triggers ArgoCD sync for the target environment.
  params:
    - name: manifestGitUrl
      description: Manifest repository URL (SSH)
      type: string
    - name: environment
      description: Target environment (dev/qa)
      type: string
    - name: imageName
      description: Image name
      type: string
    - name: imageTag
      description: New image tag
      type: string
    - name: registryUrl
      description: Container registry URL
      type: string
      default: image-registry.openshift-image-registry.svc:5000
  workspaces:
    - name: source
      description: Workspace for manifest repo clone
    - name: ssh-directory
      description: SSH credentials for git push
      optional: true
  steps:
    - name: update-manifest
      image: alpine/git:latest
      workingDir: $(workspaces.source.path)
      script: |
        #!/bin/sh
        set -e

        SSH_DIR="$(workspaces.ssh-directory.path)"

        # Configure SSH if credentials provided
        if [ -d "$SSH_DIR" ] && [ "$(ls -A $SSH_DIR 2>/dev/null)" ]; then
          echo "Configuring SSH credentials..."
          mkdir -p /root/.ssh

          # Copy known_hosts if exists
          if [ -f "$SSH_DIR/known_hosts" ]; then
            cp "$SSH_DIR/known_hosts" /root/.ssh/known_hosts
            chmod 644 /root/.ssh/known_hosts
          fi

          # Copy private key (handle both 'ssh-privatekey' and 'id_rsa' names)
          if [ -f "$SSH_DIR/ssh-privatekey" ]; then
            cp "$SSH_DIR/ssh-privatekey" /root/.ssh/id_rsa
            chmod 600 /root/.ssh/id_rsa
          elif [ -f "$SSH_DIR/id_rsa" ]; then
            cp "$SSH_DIR/id_rsa" /root/.ssh/id_rsa
            chmod 600 /root/.ssh/id_rsa
          fi

          chmod 700 /root/.ssh

          # Disable strict host key checking for GitHub
          echo "Host github.com" >> /root/.ssh/config
          echo "  StrictHostKeyChecking no" >> /root/.ssh/config
          echo "  UserKnownHostsFile /dev/null" >> /root/.ssh/config
          chmod 600 /root/.ssh/config

          echo "SSH configured successfully"
        else
          echo "Warning: No SSH credentials found"
        fi

        # Clone manifest repo
        MANIFEST_DIR="manifest-repo"
        GIT_SSH_COMMAND="ssh -o StrictHostKeyChecking=no" git clone $(params.manifestGitUrl) $MANIFEST_DIR
        cd $MANIFEST_DIR

        # Mark directory as safe (required when running as different user than owner)
        git config --global --add safe.directory "$(pwd)"

        # Configure git
        git config user.email "cicd@nousie-ai.com"
        git config user.name "UXIE CI/CD"

        # Determine overlay path
        OVERLAY_PATH="overlays/$(params.environment)"
        if [ ! -d "$OVERLAY_PATH" ]; then
          echo "ERROR: Overlay path $OVERLAY_PATH does not exist"
          exit 1
        fi

        # Update kustomization.yaml with new image tag
        KUSTOMIZATION_FILE="$OVERLAY_PATH/kustomization.yaml"
        IMAGE_REF="$(params.registryUrl)/uxie-$(params.environment)/$(params.imageName)"

        echo "Updating $KUSTOMIZATION_FILE"
        echo "  Image: $IMAGE_REF"
        echo "  Tag:   $(params.imageTag)"

        # Check if images section exists, if not create it
        if grep -q "^images:" "$KUSTOMIZATION_FILE"; then
          # Update existing image reference using sed
          sed -i "s|newTag:.*|newTag: $(params.imageTag)|" "$KUSTOMIZATION_FILE"
        else
          # Append images section
          cat >> "$KUSTOMIZATION_FILE" << EOF

        images:
          - name: $(params.imageName)
            newName: $IMAGE_REF
            newTag: $(params.imageTag)
        EOF
        fi

        # Also update deployment-patches.yaml if it exists
        PATCH_FILE="$OVERLAY_PATH/deployment-patches.yaml"
        if [ -f "$PATCH_FILE" ]; then
          echo "Updating $PATCH_FILE"
          sed -i "s|image:.*$(params.imageName).*|image: $IMAGE_REF:$(params.imageTag)|" "$PATCH_FILE"
        fi

        # Commit and push (only if there are changes)
        git add -A
        if git diff --cached --quiet; then
          echo "No changes to commit - manifest already up to date"
          echo "Skipping push - nothing changed"
        else
          git commit -m "Deploy $(params.imageName):$(params.imageTag) to $(params.environment)

        Automated deployment by UXIE CI/CD Pipeline
        Environment: $(params.environment)
        Image: $IMAGE_REF:$(params.imageTag)
        "

          # Push to the current branch (default branch after clone)
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "Pushing to branch: $CURRENT_BRANCH"
          GIT_SSH_COMMAND="ssh -o StrictHostKeyChecking=no" git push origin $CURRENT_BRANCH

          echo "Manifest updated successfully"
        fi

        echo "ArgoCD will sync automatically for $(params.environment)"
