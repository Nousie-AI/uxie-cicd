apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-manifest-custom
  namespace: uxie-cicd
spec:
  description: |
    Update GitOps manifest repository with new image tag.
    Triggers ArgoCD sync for the target environment.
  params:
    - name: manifestGitUrl
      description: Manifest repository URL (SSH)
      type: string
    - name: environment
      description: Target environment (dev/qa)
      type: string
    - name: imageName
      description: Image name
      type: string
    - name: imageTag
      description: New image tag
      type: string
    - name: registryUrl
      description: Container registry URL
      type: string
      default: image-registry.openshift-image-registry.svc:5000
  workspaces:
    - name: source
      description: Workspace for manifest repo clone
    - name: ssh-directory
      description: SSH credentials for git push
      optional: true
  steps:
    - name: update-manifest
      image: alpine/git:latest
      workingDir: $(workspaces.source.path)
      script: |
        #!/bin/bash
        set -e

        # Configure SSH if credentials provided
        if [ -d "$(workspaces.ssh-directory.path)" ]; then
          cp -R $(workspaces.ssh-directory.path)/* ~/.ssh/
          chmod 700 ~/.ssh
          chmod 600 ~/.ssh/*
        fi

        # Clone manifest repo
        MANIFEST_DIR="manifest-repo"
        git clone $(params.manifestGitUrl) $MANIFEST_DIR
        cd $MANIFEST_DIR

        # Configure git
        git config user.email "cicd@nousie-ai.com"
        git config user.name "UXIE CI/CD"

        # Determine overlay path
        OVERLAY_PATH="overlays/$(params.environment)"
        if [ ! -d "$OVERLAY_PATH" ]; then
          echo "ERROR: Overlay path $OVERLAY_PATH does not exist"
          exit 1
        fi

        # Update kustomization.yaml with new image tag
        KUSTOMIZATION_FILE="$OVERLAY_PATH/kustomization.yaml"
        IMAGE_REF="$(params.registryUrl)/uxie-$(params.environment)/$(params.imageName)"

        echo "Updating $KUSTOMIZATION_FILE"
        echo "  Image: $IMAGE_REF"
        echo "  Tag:   $(params.imageTag)"

        # Check if images section exists, if not create it
        if grep -q "^images:" "$KUSTOMIZATION_FILE"; then
          # Update existing image reference using sed
          sed -i "s|newTag:.*|newTag: $(params.imageTag)|" "$KUSTOMIZATION_FILE"
        else
          # Append images section
          cat >> "$KUSTOMIZATION_FILE" << EOF

        images:
          - name: $(params.imageName)
            newName: $IMAGE_REF
            newTag: $(params.imageTag)
        EOF
        fi

        # Also update deployment-patches.yaml if it exists
        PATCH_FILE="$OVERLAY_PATH/deployment-patches.yaml"
        if [ -f "$PATCH_FILE" ]; then
          echo "Updating $PATCH_FILE"
          sed -i "s|image:.*$(params.imageName).*|image: $IMAGE_REF:$(params.imageTag)|" "$PATCH_FILE"
        fi

        # Commit and push
        git add -A
        git commit -m "Deploy $(params.imageName):$(params.imageTag) to $(params.environment)

        Automated deployment by UXIE CI/CD Pipeline
        Environment: $(params.environment)
        Image: $IMAGE_REF:$(params.imageTag)
        "

        git push origin main

        echo "Manifest updated successfully"
        echo "ArgoCD will sync automatically for $(params.environment)"
